# Technical Debt: AWS user is over-permissioned
# Technical Debt: AWS user needs cross account access
# Technical Debt: Add SES deployment
# Technical Debt: Add CloudSearch configuration

general:
  branches:
    only:
      - production
      - staging
      - development
      
machine:
  timezone:
    America/Los_Angeles
  node:
    version: 7.6.0
  environment:
    AWS_ACCOUNT: '068070110666'
    AWS_REGION: 'us-east-1'
    SIX_VERBOSE: '2'

test:
  override:
    - npm run test-unit

deployment:
  production:
    branch: production
    commands:
      #- serverless dynamodb install --stage $CIRCLE_BRANCH && serverless dynamodb executeAll --stage $CIRCLE_BRANCH
      #- serverless deploy --stage $CIRCLE_BRANCH
      #- npm run test-integration
      - ./deployment/deploy_production.sh
  staging:
    branch: staging
    commands:
      #- serverless dynamodb install --stage $CIRCLE_BRANCH && serverless dynamodb executeAll --stage $CIRCLE_BRANCH
      #- serverless deploy --stage $CIRCLE_BRANCH
      #- npm run test-integration
      - ./deployment/utilities/merge_branches.sh staging production
  development:
    branch: development
    commands:
      - npm run lint
      - node ./deployment/sqs/purge_queues.js $CIRCLE_BRANCH $AWS_ACCOUNT $AWS_REGION
      # Truncate the databases
      - node ./deployment/cloudsearch/purge_index.js
      - serverless dynamodb install --stage $CIRCLE_BRANCH && serverless dynamodb executeAll --stage $CIRCLE_BRANCH
      - serverless deploy --stage $CIRCLE_BRANCH
      - npm run test-integration
      - ./deployment/deploy_development.sh
      - ./deployment/utilities/merge_branches.sh development staging