# Technical Debt: AWS user is over-permissioned
# Technical Debt: AWS user needs cross account access
# Technical Debt: Add SES deployment
# Technical Debt: Add CloudSearch configuration

general:
  branches:
    only:
      - production
      - staging
      - development

machine:
  timezone:
    America/Los_Angeles
  node:
    version: 7.6.0
  environment:
    SIX_VERBOSE: '2'

  services:
    #- redis
    #- elasticsearch
    # Add dynamoDB

dependencies:
  pre:
    - openssl aes-256-cbc -d -in ./deployment/config/aws.$CIRCLE_BRANCH.encrypted -k $SIX_SKELETON_KEY >> ~/.circlerc
  post:
    - echo "$AWS_ACCOUNT $AWS_REGION $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY"
    - serverless dynamodb install --stage $CIRCLE_BRANCH

test:
  override:
    - npm run lint
    - npm run test-unit


deployment:
  production:
    branch: production
    commands:
      - ./deployment/environment/deploy_production.sh
  staging:
    branch: staging
    commands:
      - serverless deploy --stage $CIRCLE_BRANCH
      - node ./deployment/sqs/deploy_queues.js $CIRCLE_BRANCH

      #CloudSearch
      #Technical Debt:  This needs to be configured for multi-environment purges
      #- node ./deployment/cloudsearch/purge_index.js $CIRCLE_BRANCH
      - node ./deployment/cloudsearch/deploy.js sixcrm-$CIRCLE_BRANCH

      #DynamoDB
      #- node ./deployment/dynamodb/purge_tables.js $CIRCLE_BRANCH
      - node ./deployment/dynamodb/deploy_tables.js $CIRCLE_BRANCH
      - node ./deployment/dynamodb/deploy_seeds.js $CIRCLE_BRANCH

      #Redshift
      #Create cluster if does not exist.
      - node ./deployment/redshift/create_cluster.js $CIRCLE_BRANCH
      #Create tables.
      - node ./deployment/redshift/deploy_redshift.js $CIRCLE_BRANCH

      # Technical Debt:  Add Elasticache and NAT Instance (where necessary)
      # Technical Debt: API Gateway Custom Domain needs to be mapped to new domain when creating and "hard updating"

      - export SIX_VERBOSE=0 && npm run test-integration

      # Merge to upper environment
      - ./deployment/utilities/merge_branches.sh staging production
  development:
    branch: development
    commands:

      #Serverless (Lambdas, API Gateway, Roles)
      - serverless deploy --stage $CIRCLE_BRANCH

      #SQS
      - node ./deployment/sqs/destroy_queues.js $CIRCLE_BRANCH
      #- node ./deployment/sqs/purge_queues.js $CIRCLE_BRANCH $AWS_ACCOUNT $AWS_REGION
      - node ./deployment/sqs/deploy_queues.js $CIRCLE_BRANCH

      #S3
      - node ./deployment/s3/destroy_buckets.js $CIRCLE_BRANCH
      - node ./deployment/s3/deploy_buckets.js $CIRCLE_BRANCH

      #Redshift
      #This works but, slows down deployments significantly...
      #- node ./deployment/redshift/destroy_cluster.js $CIRCLE_BRANCH
      - node ./deployment/redshift/deploy_cluster.js $CIRCLE_BRANCH

      #here...
      - node ./deployment/redshift/deploy_redshift.js $CIRCLE_BRANCH

      #CloudSearch
      #Technical Debt:  This needs to be configured for multi-environment purges
      # - node ./deployment/cloudsearch/deploy.js sixcrm-$CIRCLE_BRANCH
      - node ./deployment/cloudsearch/purge_index.js $CIRCLE_BRANCH

      #DynamoDB
      - node ./deployment/dynamodb/purge_tables.js $CIRCLE_BRANCH
      - node ./deployment/dynamodb/deploy_tables.js $CIRCLE_BRANCH

      #Note:  This must be last.
      - node ./deployment/dynamodb/deploy_seeds.js $CIRCLE_BRANCH


      # Technical Debt:  Add Elasticache and NAT Instance (where necessary)
      # Technical Debt:  Use Route53 for resource mappings
      # Technical Debt: API Gateway Custom Domain needs to be mapped to new domain when creating and "hard updating"

      - export SIX_VERBOSE=0 && npm run test-integration

      # Merge to upper environment
      - ./deployment/utilities/merge_branches.sh development staging
