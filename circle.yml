# Technical Debt: AWS user is over-permissioned
# Technical Debt: AWS user needs cross account access
# Technical Debt: Add SES deployment
# Technical Debt: Add CloudSearch configuration

general:
  branches:
    only:
      - production
      - staging
      - development

machine:
  timezone:
    America/Los_Angeles
  node:
    version: 7.6.0
  environment:
    #SIX_VERBOSE: '2'

  services:
    #- redis
    #- elasticsearch
    # Add dynamoDB

dependencies:
  pre:
    - openssl aes-256-cbc -d -in ./deployment/config/aws.$CIRCLE_BRANCH.encrypted -k $SIX_SKELETON_KEY >> ~/.circlerc
    - git lfs pull
  post:
    - echo "$AWS_ACCOUNT $AWS_REGION $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY"
    - serverless dynamodb install --stage $CIRCLE_BRANCH

    # Collect debug info
    #- npm ls
    #- ls node_modules -1
    #- df -h
    #- serverless --version

test:
  override:
    - npm run lint
    - npm run test-unit

deployment:
  production:
    branch: production
    commands:

      #Serverless (Lambdas, API Gateway, Roles)
      - serverless deploy --stage $CIRCLE_BRANCH

      ###########
      #EC2
      #- node ./deployment/ec2/destroy_security_groups.js
      - node ./deployment/ec2/deploy_security_groups.js
      ###########

      ###########
      #S3
      #- node ./deployment/s3/destroy_buckets.js
      - node ./deployment/s3/deploy_buckets.js
      ###########

      ###########
      #SQS
      - node ./deployment/sqs/deploy_queues.js
      #- node ./deployment/sqs/purge_queues.js
      ###########

      ###########
      #CloudSearch
      - ./tools/inCommit.sh ^deployment/cloudsearch/.* && echo "skipping, no updates" || node ./deployment/cloudsearch/deploy.js
      #- node ./deployment/cloudsearch/purge.js
      ###########

      ###########
      #ElastiCache
      - ./tools/inCommit.sh ^deployment/elasticache/.* && echo "skipping, no updates" || node ./deployment/elasticache/deploy.js
      #- node ./deployment/elasticache/purge.js
      ###########

      ###########
      #DynamoDB
      # Technical Debt: Upgrade this to purge only TEST data
      #- node ./deployment/dynamodb/purge_tables.js
      - ./tools/inCommit.sh ^model/dynamodb/.* && echo "skipping, no updates" || node ./deployment/dynamodb/deploy_tables.js
      ###########

      ##########
      #Redshift
      - ./tools/inCommit.sh ^model/redshift/.* && echo "skipping, no updates" || node ./deployment/redshift/deploy_cluster.js
      - ./tools/inCommit.sh ^model/redshift/.* && echo "skipping, no updates" || ./deployment/redshift/deploy_tables.js

      #Technical Debt:  Eliminate this.
      - echo "Pausing to allow queries to complete..." && sleep 240

      - node ./deployment/redshift/seed_referential.js
      - node ./deployment/redshift/seed_tables.js
      ###########

      ###########
      #Kinesis
      - ./tools/inCommit.sh ^deployment/kinesis/.* && echo "skipping, no updates" || node ./deployment/kinesis/deploy_streams.js
      ###########

      ###########
      #Dynamo Seeds
      - node ./deployment/dynamodb/deploy_seeds.js
      ###########

      - export SIX_VERBOSE=0 && npm run test-transactions
      - export SIX_VERBOSE=0 && npm run test-graph
      - export SIX_VERBOSE=0 && npm run test-analytics

  staging:
    branch: staging
    commands:

      #Serverless (Lambdas, API Gateway, Roles)
      - serverless deploy --stage $CIRCLE_BRANCH

      ###########
      #EC2
      #- node ./deployment/ec2/destroy_security_groups.js
      - node ./deployment/ec2/deploy_security_groups.js
      ###########

      ###########
      #S3
      #- node ./deployment/s3/destroy_buckets.js
      - node ./deployment/s3/deploy_buckets.js
      ###########

      ###########
      #SQS
      - node ./deployment/sqs/deploy_queues.js
      #- node ./deployment/sqs/purge_queues.js
      ###########

      ###########
      #CloudSearch
      - node ./deployment/cloudsearch/deploy.js
      #- node ./deployment/cloudsearch/purge.js
      ###########

      ###########
      #ElastiCache
      - node ./deployment/elasticache/deploy.js
      #- node ./deployment/elasticache/purge.js
      ###########

      ###########
      #DynamoDB
      # Technical Debt: Upgrade this to purge only TEST data
      #- node ./deployment/dynamodb/purge_tables.js
      - node ./deployment/dynamodb/deploy_tables.js
      ###########

      ##########
      #Redshift
      - node ./deployment/redshift/deploy_cluster.js
      - node ./deployment/redshift/deploy_tables.js

      #Technical Debt:  Eliminate this.
      - echo "Pausing to allow queries to complete..." && sleep 240

      - node ./deployment/redshift/seed_referential.js
      - node ./deployment/redshift/seed_tables.js
      ###########

      ###########
      #Kinesis
      - node ./deployment/kinesis/deploy_streams.js
      ###########

      ###########
      #Dynamo Seeds
      - node ./deployment/dynamodb/deploy_seeds.js
      ###########

      - export SIX_VERBOSE=0 && npm run test-transactions
      - export SIX_VERBOSE=0 && npm run test-graph
      - export SIX_VERBOSE=0 && npm run test-analytics

      # Merge to upper environment
      - ./deployment/utilities/merge_branches.sh staging production

  development:
    branch: development
    commands:

      #Serverless (Lambdas, API Gateway, Roles)
      - serverless deploy --stage $CIRCLE_BRANCH

      ###########
      #EC2
      #- node ./deployment/ec2/destroy_security_groups.js
      - node ./deployment/ec2/deploy_security_groups.js
      ###########

      ###########
      #S3
      #- node ./deployment/s3/destroy_buckets.js
      - node ./deployment/s3/deploy_buckets.js
      ###########

      ###########
      #SQS
      - node ./deployment/sqs/deploy_queues.js
      - node ./deployment/sqs/purge_queues.js
      ###########

      ###########
      #CloudSearch
      - node ./deployment/cloudsearch/deploy.js
      - node ./deployment/cloudsearch/purge.js
      ###########

      ###########
      #ElastiCache
      - node ./deployment/elasticache/deploy.js
      - node ./deployment/elasticache/purge.js
      ###########

      ###########
      #DynamoDB
      #- node ./deployment/dynamodb/purge_tables.js && exit 0;
      - node ./deployment/dynamodb/deploy_tables.js
      ###########

      ###########
      #IAM roles
      - node ./deployment/iam/destroy_roles.js
      - node ./deployment/iam/deploy_roles.js
      ###########

      ###########
      #Redshift
      - node ./deployment/redshift/deploy_cluster.js
      - node ./deployment/redshift/deploy_tables.js && echo "Pausing to allow queries to complete..." && sleep 240

      - node ./deployment/redshift/seed_referential.js
      - node ./deployment/redshift/seed_tables.js
      ###########

      ###########
      #Kinesis
      - node ./deployment/kinesis/deploy_streams.js
      ###########

      ###########
      #Dynamo Seed
      - node ./deployment/dynamodb/deploy_seeds.js
      ###########

      - export SIX_VERBOSE=0 && npm run test-transactions
      - export SIX_VERBOSE=0 && npm run test-graph
      - export SIX_VERBOSE=0 && npm run test-analytics


      # Merge to upper environment
      - ./deployment/utilities/merge_branches.sh development staging
