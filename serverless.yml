service: sixtransaction
package:
  exclude:
    - .git/**

# frameworkVersion: "=X.X.X"

provider:
  name: aws
  runtime: nodejs4.3
  stage: ${opt:stage, 'development'}
  region: us-east-1
  profile: six

plugins:
  - serverless-dynamodb-local
  - serverless-offline

custom:
  dynamodb:
    start:
      port: 8001
      inMemory: true
      migration: true
    migration:
      table_prefix: ${opt:stage}
      dir: ./dynamolocal/migrations

site_config: ${file(./config/${opt:stage}/site.yml)}

functions:
  verifysignature:
    handler: authorizers/verifysignature/handler.verifysignature
    environment:
      access_keys_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.access_keys_table}
      users_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.users_table}
      stage: ${opt:stage}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}

  verifyjwt:
    handler: authorizers/verifyjwt/handler.verifyjwt
    environment:
      users_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.users_table}
      secret_key: ${file(./config/${opt:stage}/site.yml):jwt.transaction_key}
      stage: ${opt:stage}
      development_bypass: ${file(./config/${opt:stage}/site.yml):jwt.development_bypass}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}

  verifyauth0jwt:
    handler: authorizers/verifyjwt/handler.verifyjwt
    environment:
      users_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.users_table}
      secret_key: ${file(./config/${opt:stage}/site.yml):jwt.site_key}
      stage: ${opt:stage}
      development_bypass: ${file(./config/${opt:stage}/site.yml):jwt.development_bypass}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}

  graph:
    handler: endpoints/graph/handler.graph
    events:
      - http:
          path: graph/
          method: post
          cors: true
          authorizer:
            name: verifyauth0jwt
            resultTtlInSeconds: 0
            identitySource: method.request.header.Authorization
    environment:
      stage: ${opt:stage}
      customers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.customers_table}
      sessions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.sessions_table}
      products_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.products_table}
      credit_cards_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.credit_cards_table}
      transactions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.transactions_table}
      campaigns_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.campaigns_table}
      loadbalancers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.loadbalancers_table}
      product_schedules_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.product_schedules_table}
      affiliates_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.affiliates_table}
      merchant_providers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.merchant_providers_table}
      fulfillment_providers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.fulfillment_providers_table}
      access_keys_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.access_keys_table}
      users_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.users_table}
      rebills_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.rebills_table}
      emails_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.emails_table}
      smtp_providers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.smtp_providers_table}
      shipping_receipts_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.shipping_receipts_table}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}

  billtohold:
    handler: workers/forwardmessage/handler.forwardmessage
    events:
      - schedule:
          rate: rate(1 minute)
          enabled: true
    environment:
      stage: ${opt:stage}
      origin_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.bill_queue_url}
      destination_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.hold_queue_url}
      workerfunction: sixtransaction-${opt:stage}-processbilling

  holdtopending:
    handler: workers/forwardmessage/handler.forwardmessage
    events:
      - schedule:
          rate: rate(1 minute)
          enabled: true
    environment:
      stage: ${opt:stage}
      origin_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.hold_queue_url}
      destination_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.pending_queue_url}
      workerfunction: sixtransaction-${opt:stage}-triggerfulfillment

  pendingtoshipped:
    handler: workers/forwardmessage/handler.forwardmessage
    events:
      - schedule:
          rate: rate(1 minute)
          enabled: true
    environment:
      stage: ${opt:stage}
      origin_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.pending_queue_url}
      destination_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.shipped_queue_url}
      workerfunction: sixtransaction-${opt:stage}-confirmshipped

  shippedtodelivered:
    handler: workers/forwardmessage/handler.forwardmessage
    events:
      - schedule:
          rate: rate(1 minute)
          enabled: true
    environment:
      stage: ${opt:stage}
      origin_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.shipped_queue_url}
      destination_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.delivered_queue_url}
      workerfunction: sixtransaction-${opt:stage}-confirmdelivery

  pickrebill:
    handler: workers/pickrebill/handler.pickrebill
    events:
      - schedule:
          rate: rate(2 hours)
          enabled: true
    environment:
      stage: ${opt:stage}
      bill_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.bill_queue_url}
      rebills_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.rebills_table}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}

  processbilling:
    handler: workers/processbilling/handler.processbilling
    environment:
      stage: ${opt:stage}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}
      customers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.customers_table}
      sessions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.sessions_table}
      products_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.products_table}
      credit_cards_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.credit_cards_table}
      transactions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.transactions_table}
      campaigns_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.campaigns_table}
      loadbalancers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.loadbalancers_table}
      product_schedules_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.product_schedules_table}
      affiliates_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.affiliates_table}
      merchant_providers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.merchant_providers_table}
      fulfillment_providers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.fulfillment_providers_table}
      access_keys_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.access_keys_table}
      users_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.users_table}
      rebills_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.rebills_table}

  triggerfulfillment:
    handler: workers/triggerfulfillment/handler.triggerfulfillment
    environment:
      stage: ${opt:stage}

  confirmshipped:
    handler: workers/confirmshipped/handler.confirmshipped
    environment:
      stage: ${opt:stage}
      rebills_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.rebills_table}
      transactions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.transactions_table}
      products_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.products_table}
      shipping_receipts_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.shipping_receipts_table}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}
    
  test:
    handler: workers/test/handler.test
    environment:
      stage: ${opt:stage}
      rebills_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.rebills_table}
      transactions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.transactions_table}
      products_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.products_table}
      shipping_receipts_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.shipping_receipts_table}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}
      usps_user_id: ${file(./config/${opt:stage}/site.yml):shipping_providers.usps.user_id}
      usps_password: ${file(./config/${opt:stage}/site.yml):shipping_providers.usps.password}
      workerfunction: sixtransaction-${opt:stage}-confirmdelivered
      
  confirmdelivered:
    handler: workers/confirmdelivered/handler.confirmdelivered
    environment:
      stage: ${opt:stage}
      rebills_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.rebills_table}
      transactions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.transactions_table}
      products_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.products_table}
      shipping_receipts_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.shipping_receipts_table}
      dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}
      usps_user_id: ${file(./config/${opt:stage}/site.yml):shipping_providers.usps.user_id}
      usps_password: ${file(./config/${opt:stage}/site.yml):shipping_providers.usps.password}

  acquiretoken:
    handler: endpoints/acquiretoken/handler.acquiretoken
    events:
      - http:
         path: token/acquire
         method: get
         cors: true
         authorizer:
            name: verifysignature
            resultTtlInSeconds: 0
            identitySource: method.request.header.Authorization
    environment:
      site_secret_jwt_key: ${file(./config/${opt:stage}/site.yml):jwt.transaction_key}
      stage: ${opt:stage}

  createlead:
    handler: endpoints/createlead/handler.createlead
    events:
      - http:
         path: lead/create
         method: post
         cors: true
         authorizer:
           name: verifyjwt
           resultTtlInSeconds: 0
           identitySource: method.request.header.Authorization
    environment:
        dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}
        customers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.customers_table}
        affiliates_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.affiliates_table}
        campaigns_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.campaigns_table}
        sessions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.sessions_table}
        stage: ${opt:stage}

  createorder:
    handler: endpoints/createorder/handler.createorder
    events:
      - http:
         path: order/create
         method: post
         cors: true
         authorizer:
           name: verifyjwt
           resultTtlInSeconds: 0
           identitySource: method.request.header.Authorization
    environment:
        dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}
        customers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.customers_table}
        sessions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.sessions_table}
        products_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.products_table}
        credit_cards_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.credit_cards_table}
        transactions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.transactions_table}
        campaigns_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.campaigns_table}
        loadbalancers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.loadbalancers_table}
        product_schedules_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.product_schedules_table}
        affiliates_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.affiliates_table}
        merchant_providers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.merchant_providers_table}
        fulfillment_providers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.fulfillment_providers_table}
        rebills_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.rebills_table}
        hold_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.hold_queue_url}
        bill_failed_queue_url: ${file(./config/${opt:stage}/site.yml):sqs.bill_failed_queue_url}
        stage: ${opt:stage}

  confirmorder:
    handler: endpoints/confirmorder/handler.confirmorder
    events:
      - http:
         path: order/confirm
         method: get
         cors: true
         authorizer:
           name: verifyjwt
           resultTtlInSeconds: 0
           identitySource: method.request.header.Authorization
    environment:
        dynamo_endpoint: ${file(./config/${opt:stage}/site.yml):dynamodb.endpoint}
        sessions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.sessions_table}
        products_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.products_table}
        transactions_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.transactions_table}
        customers_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.customers_table}
        rebills_table: ${opt:stage}${file(./config/${opt:stage}/site.yml):dynamodb.rebills_table}
        stage: ${opt:stage}

resources:
  Resources:
    DynamoDBIamPolicy:
      Type: AWS::IAM::Policy
      Properties:
        PolicyName: lambda-dynamodb
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
           - Effect: Allow
             Action:
               - dynamodb:*
             Resource: arn:aws:dynamodb:*:*:table/*
           - Effect: Allow
             Action:
               - sqs:*
             Resource: arn:aws:sqs:*:*:*
           - Effect: Allow
             Action:
               - lambda:*
             Resource: arn:aws:lambda:us-east-1:*:*:*
        Roles:
          - Ref: IamRoleLambdaExecution
